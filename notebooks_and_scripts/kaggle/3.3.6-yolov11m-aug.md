---
jupyter:
  jupytext:
    text_representation:
      extension: .md
      format_name: markdown
      format_version: '1.3'
      jupytext_version: 1.17.3
  kernelspec:
    display_name: Python 3
    language: python
    name: python3
---

```python papermill={"duration": 23.982773, "end_time": "2025-07-05T21:07:24.359493", "exception": false, "start_time": "2025-07-05T21:07:00.376720", "status": "completed"}
pip install ray[tune]==2.9.3
```

```python papermill={"duration": 78.615083, "end_time": "2025-07-05T21:08:42.989651", "exception": false, "start_time": "2025-07-05T21:07:24.374568", "status": "completed"}
pip install ultralytics
```

```python papermill={"duration": 0.324831, "end_time": "2025-07-05T21:08:43.350282", "exception": false, "start_time": "2025-07-05T21:08:43.025451", "status": "completed"}
from kaggle_secrets import UserSecretsClient
user_secrets = UserSecretsClient()
wandb_api_key = user_secrets.get_secret("WANDB_API_KEY")
```

```python papermill={"duration": 3.005006, "end_time": "2025-07-05T21:08:46.449658", "exception": false, "start_time": "2025-07-05T21:08:43.444652", "status": "completed"}
import wandb
# in ENV variables api key for wandb is stored
wandb.login(key=wandb_api_key)
```

<!-- #region papermill={"duration": 0.035781, "end_time": "2025-07-05T21:08:46.521190", "exception": false, "start_time": "2025-07-05T21:08:46.485409", "status": "completed"} -->
### 1. Visualize augmentations 
<!-- #endregion -->

```python papermill={"duration": 4.859583, "end_time": "2025-07-05T21:08:51.416316", "exception": false, "start_time": "2025-07-05T21:08:46.556733", "status": "completed"}
import yaml
import cv2
import matplotlib.pyplot as plt
import albumentations as A
from pathlib import Path
from random import choice
from typing import Dict, Union, List

def visualize_augmentations(
    data_yaml_path: Union[str, Path],
    augmentation: A.BasicTransform,
    n: int = 5
) -> None:
    """
    Visualizes original and augmented images using the provided augmentation pipeline.

    :param data_yaml_path: path to YOLOv8 dataset.yaml
    :param augmentation: Albumentations augmentation pipeline
    :param n: number of random images to show
    """
    with open(data_yaml_path, 'r') as f:
        data_cfg = yaml.safe_load(f)

    # resolve full training images path
    root = Path(data_cfg['path'])
    train_dir = root / data_cfg['train']

    all_images = list(train_dir.rglob("*.jpg")) + list(train_dir.rglob("*.png"))

    for _ in range(n):
        img_path = choice(all_images)
        image = cv2.imread(str(img_path))
        image = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)

        augmented = augmentation(image=image)['image']

        # plot side by side
        fig, axs = plt.subplots(1, 2, figsize=(10, 5))
        axs[0].imshow(image)
        axs[0].set_title("Original")
        axs[0].axis("off")

        axs[1].imshow(augmented)
        axs[1].set_title("Augmented")
        axs[1].axis("off")

        plt.tight_layout()
        plt.show()
```

```python papermill={"duration": 7.85127, "end_time": "2025-07-05T21:08:59.302905", "exception": false, "start_time": "2025-07-05T21:08:51.451635", "status": "completed"}
import albumentations as A

# # hsv params
# hue_limit = int(0.015 * 180)      # ≈2.7
# sat_limit = int(0.7 * 255)        # ≈178
# val_limit = int(0.4 * 255)        # ≈102

yolo_aug_equivalent = A.Compose([
    A.HorizontalFlip(p=0.5),
    # A.HueSaturationValue(
    #     hue_shift_limit=hue_limit,
    #     sat_shift_limit=sat_limit,
    #     val_shift_limit=val_limit,
    #     p=1.0
    # ),
    A.ShiftScaleRotate(
        shift_limit=0.1,
        scale_limit=0.2,
        rotate_limit=0,
        border_mode=cv2.BORDER_CONSTANT,
        p=1.0
    )
])

dataset_yaml_path = "/kaggle/input/skyfusion-yolo-v8/SkyFusion_yolo/dataset.yaml"
visualize_augmentations(dataset_yaml_path, yolo_aug_equivalent, n=10)
```

<!-- #region papermill={"duration": 0.145818, "end_time": "2025-07-05T21:08:59.593237", "exception": false, "start_time": "2025-07-05T21:08:59.447419", "status": "completed"} -->
### 2. Train YOLOv8m baseline with augmentations
<!-- #endregion -->

```python papermill={"duration": 0.24938, "end_time": "2025-07-05T21:08:59.971109", "exception": false, "start_time": "2025-07-05T21:08:59.721729", "status": "completed"}
import wandb
from ultralytics import YOLO
from wandb.integration.ultralytics import add_wandb_callback


def run_yolov8m_augmented(data_path: str, epochs: int = 5, img_size: int = 640) -> None:
    """
    Trains YOLOv8m with augmentations tailored for small object detection from aerial imagery.
    Logs results to Weights & Biases.

    :param data_path: path to the dataset YAML file in YOLOv8 format
    :param epochs: number of training epochs
    :param img_size: image size (default: 640)
    """
    model_name = "yolo11m.pt"

    # load model
    model = YOLO(model_name)

    # train with carefully selected augmentations
    model.train(
        data=data_path,
        epochs=epochs,
        imgsz=img_size,
        cos_lr=True,      # cosine learning-rate decay
        patience=10,      # early stop if no val improvement
        save_period=10,    # checkpoint every 10 epochs
        seed=42,
        batch=4, # reduced from 8 because of OOM error
        # augmentations
        degrees=5.0,        # enable minor rotations
        translate=0.1,
        scale=0.2,
        shear=0.0,
        perspective=0.0,
        flipud=0.2,         # enable vertical flips occasionally
        fliplr=0.5,
        mosaic=0.0,        # UPDATE: turn off mosaic aug completely
        mixup=0.0
    )

```

```python papermill={"duration": 14629.469366, "end_time": "2025-07-06T01:12:49.570630", "exception": false, "start_time": "2025-07-05T21:09:00.101264", "status": "completed"}
from pathlib import Path

data_file_path = "/kaggle/input/skyfusion-yolo-v8/SkyFusion_yolo/dataset.yaml"

assert Path(data_file_path).exists(), f"Dataset file not found at {data_file_path}"
run_yolov8m_augmented(data_file_path, epochs=100)
```
