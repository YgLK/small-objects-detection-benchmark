---
jupyter:
  jupytext:
    text_representation:
      extension: .md
      format_name: markdown
      format_version: '1.3'
      jupytext_version: 1.17.3
  kernelspec:
    display_name: Python 3
    language: python
    name: python3
---

```python papermill={"duration": 0.011506, "end_time": "2025-07-08T17:25:34.794450", "exception": false, "start_time": "2025-07-08T17:25:34.782944", "status": "completed"}
# pip install --upgrade ultralytics==8.0.238 wandb
```

```python papermill={"duration": 71.721032, "end_time": "2025-07-08T17:26:46.517634", "exception": false, "start_time": "2025-07-08T17:25:34.796602", "status": "completed"}
pip install ultralytics
```

<!-- #region papermill={"duration": 0.018585, "end_time": "2025-07-08T17:26:46.554987", "exception": false, "start_time": "2025-07-08T17:26:46.536402", "status": "completed"} -->
Without wandb becuase of problem with loading the model with older Pytorch version (older ultralytics dependency, because wandb doesnt work with the newest version unfortunately...) 
<!-- #endregion -->

```python papermill={"duration": 0.024871, "end_time": "2025-07-08T17:26:46.598351", "exception": false, "start_time": "2025-07-08T17:26:46.573480", "status": "completed"}
# pip install ray[tune]==2.9.3
```

```python papermill={"duration": 0.023378, "end_time": "2025-07-08T17:26:46.640213", "exception": false, "start_time": "2025-07-08T17:26:46.616835", "status": "completed"}
# from kaggle_secrets import UserSecretsClient
# user_secrets = UserSecretsClient()
# wandb_api_key = user_secrets.get_secret("WANDB_API_KEY")
```

```python papermill={"duration": 0.023538, "end_time": "2025-07-08T17:26:46.682137", "exception": false, "start_time": "2025-07-08T17:26:46.658599", "status": "completed"}
# import wandb
# # in ENV variables api key for wandb is stored
# wandb.login(key=wandb_api_key)
```

<!-- #region papermill={"duration": 0.018268, "end_time": "2025-07-08T17:26:46.719477", "exception": false, "start_time": "2025-07-08T17:26:46.701209", "status": "completed"} -->
### 1. Train RT-DETR with augmentations
<!-- #endregion -->

```python papermill={"duration": 4.166459, "end_time": "2025-07-08T17:26:50.904320", "exception": false, "start_time": "2025-07-08T17:26:46.737861", "status": "completed"}
# import wandb
from ultralytics import RTDETR
# from wandb.integration.ultralytics import add_wandb_callback


def run_rtdetr_augmented(data_path: str, epochs: int = 5, img_size: int = 640) -> None:
    """
    Trains YOLOv8m with augmentations tailored for small object detection from aerial imagery.
    Logs results to Weights & Biases.

    :param data_path: path to the dataset YAML file in YOLOv8 format
    :param epochs: number of training epochs
    :param img_size: image size (default: 640)
    """
    # start a new wandb run
    # wandb.init(project="object-detection-small", name="yolov8m-aug-100epochs-cos_lr", job_type="augmented")
    # wandb.init(project="small-objects-transformers", name="rtdetr-baseline-aug", job_type="augmented")

    # load model
    model = RTDETR("rtdetr-l.pt")

    # attach wandb callback
    # add_wandb_callback(model, enable_model_checkpointing=False)

    # train with carefully selected augmentations
    model.train(
        data=data_path,
        epochs=epochs,
        imgsz=img_size,
        cos_lr=True,      # cosine learning-rate decay
        patience=10,      # early stop if no val improvement
        save_period=10,    # checkpoint every 10 epochs
        warmup_epochs=5,
        seed=42,
        batch=4, # reduced from 8 because of OOM error
        # augmentations
        degrees=5.0,        # enable minor rotations
        translate=0.1,
        scale=0.2,
        shear=0.0,
        perspective=0.0,
        flipud=0.2,         # enable vertical flips occasionally
        fliplr=0.5,
        mosaic=1.0,
        mixup=0.0
    )

    # finish wandb run
    wandb.finish()
```

```python papermill={"duration": 0.025575, "end_time": "2025-07-08T17:26:50.949150", "exception": false, "start_time": "2025-07-08T17:26:50.923575", "status": "completed"}
def save_yaml_file(file_path: str, yaml_content: str) -> None:
    """
    Save a YAML-formatted string to a file.

    Args:
        file_path (str): Destination file path (e.g., 'dataset.yaml').
        yaml_content (str): YAML content as a raw string.
    """
    with open(file_path, "w", encoding="utf-8") as file:
        file.write(yaml_content)


yaml_content = """# SkyFusion dataset in YOLO format
path: /kaggle/input/SkyFusion_yolo  # dataset root dir
train: images/train  # train images
val: images/valid  # val images
test: images/test  # test images

# Classes
names:
  0: aircraft
  1: ship
  2: vehicle
"""

save_yaml_file("dataset.yaml", yaml_content)
```

```python papermill={"duration": 11096.498634, "end_time": "2025-07-08T20:31:47.479817", "exception": true, "start_time": "2025-07-08T17:26:50.981183", "status": "failed"}
from pathlib import Path

# data_file_path = "/kaggle/input/SkyFusion_yolo/dataset.yaml"
data_file_path = "/kaggle/working/dataset.yaml"

assert Path(data_file_path).exists(), f"Dataset file not found at {data_file_path}"
run_rtdetr_augmented(data_file_path, epochs=100)
```
