---
jupyter:
  jupytext:
    text_representation:
      extension: .md
      format_name: markdown
      format_version: '1.3'
      jupytext_version: 1.17.3
  kernelspec:
    display_name: Python 3
    language: python
    name: python3
---

```python papermill={"duration": 88.83186, "end_time": "2025-06-01T20:12:31.788673", "exception": false, "start_time": "2025-06-01T20:11:02.956813", "status": "completed"}
pip install --upgrade ultralytics==8.0.238 wandb
```

```python papermill={"duration": 10.960684, "end_time": "2025-06-01T20:12:42.771252", "exception": false, "start_time": "2025-06-01T20:12:31.810568", "status": "completed"}
pip install ray[tune]==2.9.3
```

```python papermill={"duration": 0.127852, "end_time": "2025-06-01T20:12:42.922210", "exception": false, "start_time": "2025-06-01T20:12:42.794358", "status": "completed"}
from kaggle_secrets import UserSecretsClient
user_secrets = UserSecretsClient()
wandb_api_key = user_secrets.get_secret("WANDB_API_KEY")
```

```python papermill={"duration": 2.439925, "end_time": "2025-06-01T20:12:45.385459", "exception": false, "start_time": "2025-06-01T20:12:42.945534", "status": "completed"}
import wandb
# in ENV variables api key for wandb is stored
wandb.login(key=wandb_api_key)
```

<!-- #region papermill={"duration": 0.022525, "end_time": "2025-06-01T20:12:45.431688", "exception": false, "start_time": "2025-06-01T20:12:45.409163", "status": "completed"} -->
### 1. Visualize augmentations 
<!-- #endregion -->

```python papermill={"duration": 4.487461, "end_time": "2025-06-01T20:12:49.941826", "exception": false, "start_time": "2025-06-01T20:12:45.454365", "status": "completed"}
import yaml
import cv2
import matplotlib.pyplot as plt
import albumentations as A
from pathlib import Path
from random import choice
from typing import Dict, Union, List

def visualize_augmentations(
    data_yaml_path: Union[str, Path],
    augmentation: A.BasicTransform,
    n: int = 5
) -> None:
    """
    Visualizes original and augmented images using the provided augmentation pipeline.

    :param data_yaml_path: path to YOLOv8 dataset.yaml
    :param augmentation: Albumentations augmentation pipeline
    :param n: number of random images to show
    """
    with open(data_yaml_path, 'r') as f:
        data_cfg = yaml.safe_load(f)

    # resolve full training images path
    root = Path(data_cfg['path'])
    train_dir = root / data_cfg['train']

    all_images = list(train_dir.rglob("*.jpg")) + list(train_dir.rglob("*.png"))

    for _ in range(n):
        img_path = choice(all_images)
        image = cv2.imread(str(img_path))
        image = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)

        augmented = augmentation(image=image)['image']

        # plot side by side
        fig, axs = plt.subplots(1, 2, figsize=(10, 5))
        axs[0].imshow(image)
        axs[0].set_title("Original")
        axs[0].axis("off")

        axs[1].imshow(augmented)
        axs[1].set_title("Augmented")
        axs[1].axis("off")

        plt.tight_layout()
        plt.show()
```

```python papermill={"duration": 11.172224, "end_time": "2025-06-01T20:13:01.137550", "exception": false, "start_time": "2025-06-01T20:12:49.965326", "status": "completed"}
import albumentations as A

# # hsv params
# hue_limit = int(0.015 * 180)      # ≈2.7
# sat_limit = int(0.7 * 255)        # ≈178
# val_limit = int(0.4 * 255)        # ≈102

yolo_aug_equivalent = A.Compose([
    A.HorizontalFlip(p=0.5),
    # A.HueSaturationValue(
    #     hue_shift_limit=hue_limit,
    #     sat_shift_limit=sat_limit,
    #     val_shift_limit=val_limit,
    #     p=1.0
    # ),
    A.ShiftScaleRotate(
        shift_limit=0.1,
        scale_limit=0.2,
        rotate_limit=0,
        border_mode=cv2.BORDER_CONSTANT,
        p=1.0
    )
])

dataset_yaml_path = "/kaggle/input/skyfusion-yolo-v8/SkyFusion_yolo/dataset.yaml"
visualize_augmentations(dataset_yaml_path, yolo_aug_equivalent, n=10)
```

```python papermill={"duration": 0.829424, "end_time": "2025-06-01T20:13:02.113672", "exception": false, "start_time": "2025-06-01T20:13:01.284248", "status": "completed"}
!git clone https://github.com/Y-T-G/community
```

```python papermill={"duration": 5.229137, "end_time": "2025-06-01T20:13:07.485627", "exception": false, "start_time": "2025-06-01T20:13:02.256490", "status": "completed"}
!pip install --upgrade ultralytics
```

<!-- #region papermill={"duration": 0.13175, "end_time": "2025-06-01T20:13:07.756948", "exception": false, "start_time": "2025-06-01T20:13:07.625198", "status": "completed"} -->
### 2. Train YOLOv8m baseline with augmentations
<!-- #endregion -->

<!-- #region papermill={"duration": 0.135799, "end_time": "2025-06-01T20:13:08.022546", "exception": false, "start_time": "2025-06-01T20:13:07.886747", "status": "completed"} -->
### UPDATE: For that models wandb tracking isn't available unfortunately. (wandb requires lower version of ultralytics)
<!-- #endregion -->

```python papermill={"duration": 35382.340667, "end_time": "2025-06-02T06:02:50.497116", "exception": false, "start_time": "2025-06-01T20:13:08.156449", "status": "completed"}
# import wandb
from ultralytics import YOLO
# from wandb.integration.ultralytics import add_wandb_callback


"""
Trains YOLOv8m with augmentations tailored for small object detection from aerial imagery.
Logs results to Weights & Biases.

:param data_path: path to the dataset YAML file in YOLOv8 format
:param epochs: number of training epochs
:param img_size: image size (default: 640)
"""

DATA_PATH = "/kaggle/input/skyfusion-yolo-v8/SkyFusion_yolo/dataset.yaml"
IMG_SIZE = 640
EPOCHS = 300
MODEL_CFG_PATH = "/kaggle/working/community/cfg/detect/yolo11m-p2.yaml"

# start a new wandb run
# wandb.init(project="object-detection-small", name="yolov11m-p2", job_type="yolov11")

# load model
model = YOLO(MODEL_CFG_PATH)

# attach wandb callback
# add_wandb_callback(model, enable_model_checkpointing=True)

# train with carefully selected augmentations
model.train(
    data=DATA_PATH,
    epochs=EPOCHS,
    imgsz=IMG_SIZE,
    cos_lr=True,      # cosine learning-rate decay
    patience=10,      # early stop if no val improvement
    save_period=30,    # checkpoint every 10 epochs
    seed=42,
    batch=4, # reduced from 8 because of OOM error
    # augmentations
    degrees=0.0,
    translate=0.1,
    scale=0.2,
    shear=0.0,
    perspective=0.0,
    flipud=0.0,
    fliplr=0.5,
    mosaic=1.0,
    mixup=0.0,
)
```
